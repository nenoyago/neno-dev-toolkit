name: Validate Changeset

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-changeset:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Skip CI for auto-release commits
      - name: ğŸš« Skip auto-release commits
        id: skip_commit
        run: |
          # Pega o Ãºltimo commit como uma Ãºnica linha
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B | tr '\n' ' ')
          echo "Last commit: $LAST_COMMIT_MSG"

          if echo "$LAST_COMMIT_MSG" | grep -q '\[skip ci\]'; then
            echo "âš ï¸ Commit de auto-release detectado, pulando validaÃ§Ã£o..."
            echo "skip_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_commit=false" >> "$GITHUB_OUTPUT"
          fi

      # 3ï¸âƒ£ Stop workflow if auto-release commit
      - name: â¹ï¸ Stop if auto-release commit
        if: steps.skip_commit.outputs.skip_commit == 'true'
        run: |
          echo "Auto-release commit detected. Skipping changeset validation."
          exit 0

      # 4ï¸âƒ£ Validate branch name & skip logic
      - name: ğŸ·ï¸ Validate branch name
        id: branch
        run: |
          BRANCH="${{ github.head_ref }}"

          # Prefixos permitidos para PR branches
          ALLOWED_PREFIXES="^(feat/|feature/|fix/|hotfix/|docs/|test/|refactor/|chore/|release/|beta/)"
          if [[ ! "$BRANCH" =~ $ALLOWED_PREFIXES ]]; then
            echo "ğŸš¨ Branch invÃ¡lido: $BRANCH. Use um dos prefixes permitidos."
            exit 1
          else
            echo "âœ… Branch vÃ¡lido: $BRANCH"
          fi

          # Pular checagem de changeset para release/chore branches
          if [[ "$BRANCH" =~ ^(release/|chore/) ]]; then
            echo "âš ï¸ Branch release ou chore detectada ($BRANCH); pulando validaÃ§Ã£o de changeset."
            echo "skip_changeset=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_changeset=false" >> "$GITHUB_OUTPUT"
          fi

      # 5ï¸âƒ£ Validate presence of changeset
      - name: ğŸ“ Validate changeset presence
        if: steps.branch.outputs.skip_changeset == 'false'
        id: validate_changeset
        continue-on-error: true
        run: |
          # MÃ©todo mais robusto para contar changesets
          if [ -d ".changeset" ]; then
            COUNT=$(find .changeset -maxdepth 1 -name "*.md" -not -name "README.md" | wc -l | tr -d ' ')
            echo "Changesets encontrados: $COUNT"
            
            if [ "$COUNT" -eq 0 ]; then
              echo "changeset_found=false" >> "$GITHUB_OUTPUT"
              echo "changeset_count=0" >> "$GITHUB_OUTPUT"
              echo "âŒ Nenhum changeset encontrado."
              exit 1
            else
              echo "changeset_found=true" >> "$GITHUB_OUTPUT"
              echo "changeset_count=$COUNT" >> "$GITHUB_OUTPUT"
              echo "âœ… Changeset(s) vÃ¡lido(s) encontrado(s): $COUNT"
            fi
          else
            echo "changeset_found=false" >> "$GITHUB_OUTPUT"
            echo "changeset_count=0" >> "$GITHUB_OUTPUT"
            echo "âŒ DiretÃ³rio .changeset nÃ£o encontrado"
            exit 1
          fi

      # 6ï¸âƒ£ Find existing bot comment
      - name: ğŸ” Find existing comment
        if: always() && steps.branch.outputs.skip_changeset == 'false'
        uses: actions/github-script@v7
        id: find_comment
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(comment => 
              comment.body.includes('## âŒ Changeset NÃ£o Encontrado') ||
              comment.body.includes('## âœ… Changeset Encontrado')
            );

            return botComment ? botComment.id : null;

      # 7ï¸âƒ£ Update comment if changeset is missing
      - name: ğŸ’¬ Update comment (Missing)
        if: always() && steps.branch.outputs.skip_changeset == 'false' && steps.validate_changeset.outputs.changeset_found == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const commentBody = `## âŒ Changeset NÃ£o Encontrado

            Esta PR precisa de um **changeset** para documentar as mudanÃ§as.

            ### ğŸ“‹ Como adicionar um changeset:

            **OpÃ§Ã£o 1: Changeset com descriÃ§Ã£o (recomendado)**
            \`\`\`bash
            pnpm changeset:bump
            \`\`\`
            â†³ Abre um prompt interativo para selecionar pacotes, tipo de versÃ£o e descrever mudanÃ§as.

            **OpÃ§Ã£o 2: Changeset vazio (apenas para mudanÃ§as triviais)**
            \`\`\`bash
            pnpm changeset:empty
            \`\`\`
            â†³ Cria um changeset vazio sem bump de versÃ£o.

            ### ğŸ” Passos do changeset interativo:
            1. âœ… Selecionar os pacotes afetados
            2. ğŸ“Š Escolher o tipo de versÃ£o:
               - \`patch\` (0.0.x) - correÃ§Ãµes de bugs
               - \`minor\` (0.x.0) - novas features compatÃ­veis
               - \`major\` (x.0.0) - breaking changes
            3. ğŸ“ Descrever as mudanÃ§as

            ### ğŸ“š DocumentaÃ§Ã£o
            - [Changesets Guide](https://github.com/changesets/changesets/blob/main/docs/intro-to-using-changesets.md)

            ---
            *ğŸ¤– Ãšltima verificaÃ§Ã£o: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}*`;

            const commentId = ${{ steps.find_comment.outputs.result }};

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      # 8ï¸âƒ£ Update comment if changeset is found
      - name: âœ… Update comment (Success)
        if: always() && steps.branch.outputs.skip_changeset == 'false' && steps.validate_changeset.outputs.changeset_found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const count = ${{ steps.validate_changeset.outputs.changeset_count }};
            const commentBody = `## âœ… Changeset Encontrado

            Perfeito! Esta PR contÃ©m **${count} changeset(s)** vÃ¡lido(s). âœ¨

            ### ğŸ“¦ PrÃ³ximos passos:
            - Os changesets serÃ£o processados automaticamente apÃ³s o merge
            - As versÃµes dos pacotes serÃ£o atualizadas conforme especificado
            - Um changelog serÃ¡ gerado automaticamente

            ---
            *ğŸ¤– Ãšltima verificaÃ§Ã£o: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' })}*`;

            const commentId = ${{ steps.find_comment.outputs.result }};

            if (commentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: commentId,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      # 9ï¸âƒ£ Final validation status
      - name: ğŸ¯ Final validation
        if: steps.branch.outputs.skip_changeset == 'false' && steps.validate_changeset.outputs.changeset_found == 'false'
        run: |
          echo "âŒ Workflow falhou: changeset nÃ£o encontrado"
          exit 1
