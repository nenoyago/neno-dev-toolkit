name: Validate Changeset

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-changeset:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Skip CI for auto-release commits
      - name: ğŸš« Skip auto-release commits
        id: skip_commit
        run: |
          # Pega o Ãºltimo commit como uma Ãºnica linha
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B | tr '\n' ' ')
          echo "Last commit: $LAST_COMMIT_MSG"

          if echo "$LAST_COMMIT_MSG" | grep -q '\[skip ci\]'; then
            echo "âš ï¸ Commit de auto-release detectado, pulando validaÃ§Ã£o..."
            echo "skip_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_commit=false" >> "$GITHUB_OUTPUT"
          fi

      # 3ï¸âƒ£ Stop workflow if auto-release commit
      - name: â¹ï¸ Stop if auto-release commit
        if: steps.skip_commit.outputs.skip_commit == 'true'
        run: |
          echo "Auto-release commit detected. Skipping changeset validation."
          exit 0

      # 4ï¸âƒ£ Validate branch name & skip logic
      - name: ğŸ·ï¸ Validate branch name
        id: branch
        run: |
          BRANCH="${{ github.head_ref }}"

          # Prefixos permitidos para PR branches
          ALLOWED_PREFIXES="^(feat/|feature/|fix/|hotfix/|docs/|test/|refactor/|chore/|release/|beta/)"
          if [[ ! "$BRANCH" =~ $ALLOWED_PREFIXES ]]; then
            echo "ğŸš¨ Branch invÃ¡lido: $BRANCH. Use um dos prefixes permitidos."
            exit 1
          else
            echo "âœ… Branch vÃ¡lido: $BRANCH"
          fi

          # Pular checagem de changeset para release/chore branches
          if [[ "$BRANCH" =~ ^(release/|chore/) ]]; then
            echo "âš ï¸ Branch release ou chore detectada ($BRANCH); pulando validaÃ§Ã£o de changeset."
            echo "skip_changeset=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_changeset=false" >> "$GITHUB_OUTPUT"
          fi

      # 5ï¸âƒ£ Validate presence of changeset (CORRIGIDO)
      - name: ğŸ“ Validate changeset presence
        if: steps.branch.outputs.skip_changeset == 'false'
        run: |
          # MÃ©todo mais robusto para contar changesets
          if [ -d ".changeset" ]; then
            COUNT=$(find .changeset -maxdepth 1 -name "*.md" -not -name "README.md" | wc -l | tr -d ' ')
            echo "Changesets encontrados: $COUNT"
            
            if [ "$COUNT" -eq 0 ]; then
              echo "âŒ Nenhum changeset encontrado. Adicione um arquivo .md em .changeset/"
              echo "ğŸ’¡ Execute: pnpm changeset"
              exit 1
            else
              echo "âœ… Changeset(s) vÃ¡lido(s) encontrado(s): $COUNT"
            fi
          else
            echo "âŒ DiretÃ³rio .changeset nÃ£o encontrado"
            exit 1
          fi
